{% extends "base.html" %}
{% from "macros.html" import render_user_card %}

{% block title %}User Management - Flask RBAC App{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2><i class="bi bi-people"></i> User Management</h2>
            <a href="{{ url_for('admin.dashboard') }}" class="btn btn-outline-primary">
                <i class="bi bi-arrow-left"></i> Back to Admin
            </a>
        </div>
    </div>
</div>

<!-- Role Assignment Modal -->
<div class="modal fade" id="assignRoleModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Assign Role</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="" id="assignRoleForm">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="role_name" class="form-label">Role</label>
                        <select class="form-select" name="role_name" id="role_name" required>
                            <option value="">Select a role...</option>
                            <!-- Roles will be populated by JavaScript -->
                        </select>
                    </div>
                    <input type="hidden" name="user_id" id="assign_user_id">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Assign Role</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Remove Role Modal -->
<div class="modal fade" id="removeRoleModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Remove Role</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="" id="removeRoleForm">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="remove_role_name" class="form-label">Role</label>
                        <select class="form-select" name="role_name" id="remove_role_name" required>
                            <option value="">Select a role...</option>
                            <!-- Roles will be populated by JavaScript -->
                        </select>
                    </div>
                    <input type="hidden" name="user_id" id="remove_user_id">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-danger">Remove Role</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Users List -->
<div class="row">
    <div class="col-12">
        {% if users %}
            {% for user in users %}
                <div class="card mb-3">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <h5 class="card-title">{{ user.email }}</h5>
                                <p class="card-text">
                                    <small class="text-muted">
                                        <i class="bi bi-calendar"></i> Joined {{ user.created_at.strftime('%B %d, %Y') }}
                                    </small>
                                </p>
                                <div class="mt-2">
                                    {% for role in user.roles %}
                                        <span class="badge bg-secondary me-1">{{ role.name }}</span>
                                    {% endfor %}
                                </div>
                            </div>
                            <div class="dropdown">
                                <button class="btn btn-outline-secondary btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                    Actions
                                </button>
                                <ul class="dropdown-menu">
                                    <li>
                                        <button class="dropdown-item" onclick="openAssignRoleModal('{{ user.id }}')">
                                            <i class="bi bi-plus-circle"></i> Assign Role
                                        </button>
                                    </li>
                                    <li>
                                        <button class="dropdown-item" onclick="openRemoveRoleModal('{{ user.id }}', {{ user.roles|list|tojson }})">
                                            <i class="bi bi-dash-circle"></i> Remove Role
                                        </button>
                                    </li>
                                    <li><hr class="dropdown-divider"></li>
                                    <li>
                                        <form method="POST" action="{{ url_for('admin.toggle_user_active', user_id=user.id) }}" class="d-inline">
                                            <button type="submit" class="dropdown-item">
                                                {% if user.is_active %}
                                                    <i class="bi bi-person-x"></i> Deactivate
                                                {% else %}
                                                    <i class="bi bi-person-check"></i> Activate
                                                {% endif %}
                                            </button>
                                        </form>
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            {% endfor %}
        {% else %}
            <div class="text-center py-5">
                <i class="bi bi-people text-muted" style="font-size: 3rem;"></i>
                <h4 class="text-muted mt-3">No Users Found</h4>
                <p class="text-muted">No users have been registered yet.</p>
            </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Available roles (populated from server)
const availableRoles = {{ roles|tojson if roles else '[]' }};

function openAssignRoleModal(userId) {
    document.getElementById('assign_user_id').value = userId;
    document.getElementById('assignRoleForm').action = `/admin/users/${userId}/roles`;
    
    const roleSelect = document.getElementById('role_name');
    roleSelect.innerHTML = '<option value="">Select a role...</option>';
    availableRoles.forEach(role => {
        const option = document.createElement('option');
        option.value = role.name;
        option.textContent = role.name;
        roleSelect.appendChild(option);
    });
    
    new bootstrap.Modal(document.getElementById('assignRoleModal')).show();
}

function openRemoveRoleModal(userId, userRoles) {
    document.getElementById('remove_user_id').value = userId;
    document.getElementById('removeRoleForm').action = `/admin/users/${userId}/roles/remove`;
    
    const roleSelect = document.getElementById('remove_role_name');
    roleSelect.innerHTML = '<option value="">Select a role...</option>';
    userRoles.forEach(role => {
        const option = document.createElement('option');
        option.value = role.name;
        option.textContent = role.name;
        roleSelect.appendChild(option);
    });
    
    new bootstrap.Modal(document.getElementById('removeRoleModal')).show();
}
</script>
{% endblock %}
