{% extends "admin/base.html" %}

{% block title %}User Management{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item text-sm text-dark active font-weight-bold" aria-current="page">User Management</li>
{% endblock %}

{% block content %}
<div class="row">
  <div class="col-lg-12 position-relative z-index-2">
    <div class="ms-3">
      <h3 class="mb-0 h4 font-weight-bolder">User Management</h3>
      <p class="mb-4">Manage users, roles, and permissions.</p>
    </div>

    <!-- Users List -->
    <div class="row">
      <div class="col-12">
        <div class="card">
          <div class="card-header pb-0">
            <h6 class="mb-0">All Users</h6>
          </div>
          <div class="card-body px-0 pt-0 pb-2">
            {% if users %}
              <div class="table-responsive p-0">
                <table class="table align-items-center mb-0" id="users-table">
                  <thead>
                    <tr>
                      <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">Avatar</th>
                      <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">Email</th>
                      <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7 ps-2">Roles</th>
                      <th class="text-center text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">Status</th>
                      <th class="text-secondary opacity-7">Joined</th>
                      <th class="text-secondary opacity-7">Actions</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for user in users %}
                      <tr>
                        <td>
                          <div class="d-flex px-2 py-1">
                            <div>
                              <img src="{{ user.get_avatar_url() }}" class="avatar avatar-sm me-2" alt="{{ user.email }}">
                            </div>
                          </div>
                        </td>
                        <td>
                          <div class="d-flex px-2 py-1">
                            <div class="d-flex flex-column justify-content-center">
                              <h6 class="mb-0 text-sm">
                                <a href="{{ url_for('admin.view_user_settings', user_id=user.id) }}" class="text-primary text-decoration-underline">
                                  {{ user.email }}
                                </a>
                              </h6>
                              <p class="text-xs text-secondary mb-0">{{ user.created_at.strftime('%B %d, %Y') }}</p>
                            </div>
                          </div>
                        </td>
                        <td>
                          {% for role in user.roles %}
                            <span class="badge badge-sm bg-gradient-secondary me-1">{{ role.name }}</span>
                          {% endfor %}
                        </td>
                        <td class="align-middle text-center text-sm">
                          <span class="badge badge-sm bg-gradient-{{ 'success' if user.is_active else 'danger' }}">
                            {{ 'Active' if user.is_active else 'Inactive' }}
                          </span>
                        </td>
                        <td class="align-middle">
                          <span class="text-secondary text-xs font-weight-bold">{{ user.created_at.strftime('%B %d, %Y') }}</span>
                        </td>
                        <td class="align-middle">
                          <div class="dropdown">
                            <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                              Actions
                            </button>
                            <ul class="dropdown-menu">
                              <li>
                                <button class="dropdown-item" onclick="openAssignRoleModal('{{ user.id }}')">
                                  <i class="material-symbols-rounded me-1">add_circle</i> Assign Role
                                </button>
                              </li>
                              <li>
                                <button class="dropdown-item remove-role-btn"
                                        data-user-id="{{ user.id }}"
                                        data-user-roles="{{ user.roles|map(attribute='name')|join(',') }}">
                                  <i class="material-symbols-rounded me-1">remove_circle</i> Remove Role
                                </button>
                              </li>
                              <li><hr class="dropdown-divider"></li>
                              <li>
                                <form method="POST" action="{{ url_for('admin.toggle_user_active', user_id=user.id) }}" class="d-inline">
                                  <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                  <button type="submit" class="dropdown-item">
                                    {% if user.is_active %}
                                      <i class="material-symbols-rounded me-1">person_off</i> Deactivate
                                    {% else %}
                                      <i class="material-symbols-rounded me-1">person</i> Activate
                                    {% endif %}
                                  </button>
                                </form>
                              </li>
                              <li><hr class="dropdown-divider"></li>
                              <li>
                                <button class="dropdown-item text-danger delete-user-btn"
                                        data-user-id="{{ user.id }}"
                                        data-user-email="{{ user.email }}"
                                        data-user-username="{{ user.username }}"
                                        data-project-count="{{ user.projects.count() }}">
                                  <i class="material-symbols-rounded me-1">delete</i> Delete User
                                </button>
                              </li>
                            </ul>
                          </div>
                        </td>
                      </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            {% else %}
              <div class="text-center py-5">
                <i class="material-symbols-rounded text-muted" style="font-size: 3rem;">people</i>
                <h4 class="text-muted mt-3">No Users Found</h4>
                <p class="text-muted">No users have been registered yet.</p>
              </div>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Role Assignment Modal -->
<div class="modal fade" id="assignRoleModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Assign Role</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <form method="POST" action="" id="assignRoleForm">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
        <div class="modal-body">
          <div class="mb-3">
            <label for="role_name" class="form-label">Role</label>
            <select class="form-control" name="role_name" id="role_name" required>
              <option value="">Select a role...</option>
            </select>
          </div>
          <input type="hidden" name="user_id" id="assign_user_id">
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Assign Role</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Remove Role Modal -->
<div class="modal fade" id="removeRoleModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Remove Role</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <form method="POST" action="" id="removeRoleForm">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
        <div class="modal-body">
          <div class="mb-3">
            <label for="remove_role_name" class="form-label">Role</label>
            <select class="form-control" name="role_name" id="remove_role_name" required>
              <option value="">Select a role...</option>
            </select>
          </div>
          <input type="hidden" name="user_id" id="remove_user_id">
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-danger">Remove Role</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Delete/Anonymize User Modal -->
<div class="modal fade" id="deleteUserModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Delete or Anonymize User</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="alert alert-warning" role="alert">
          <strong>Warning:</strong> This action cannot be undone!
        </div>
        <p>You are about to delete or anonymize the following user:</p>
        <ul class="list-unstyled ms-3">
          <li><strong>Email:</strong> <span id="delete_user_email"></span></li>
          <li><strong>Username:</strong> <span id="delete_user_username"></span></li>
          <li><strong>Projects:</strong> <span id="delete_user_projects_count"></span></li>
        </ul>
        <div class="alert alert-danger mt-3" role="alert">
          <strong>What will be deleted:</strong>
          <ul class="mb-0">
            <li>All projects owned by this user (<span id="delete_projects_count_detail"></span>)</li>
            <li>All user sessions</li>
            <li>User avatar</li>
            <li id="hard_delete_detail" style="display: none;">User account (permanent deletion)</li>
            <li id="anonymize_detail" style="display: none;">All personally identifiable information (email, username, name, avatar)</li>
          </ul>
        </div>
        <p class="text-muted small">
          <strong>Hard Delete:</strong> Completely removes the user record. Use for GDPR right to erasure requests.<br>
          <strong>Anonymize:</strong> Removes PII but keeps the user record for statistics and reports. GDPR-compliant alternative.
        </p>
        <p class="text-danger small mb-0">
          <strong>Note:</strong> You cannot delete or anonymize your own account.
        </p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <form method="POST" action="" id="anonymizeUserForm" class="d-inline">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
          <button type="submit" class="btn btn-warning">
            <i class="material-symbols-rounded me-1" style="vertical-align: middle;">admin_panel_settings</i> Anonymize
          </button>
        </form>
        <form method="POST" action="" id="deleteUserForm" class="d-inline">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
          <button type="submit" class="btn btn-danger">
            <i class="material-symbols-rounded me-1" style="vertical-align: middle;">delete_forever</i> Hard Delete
          </button>
        </form>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_scripts %}
<!-- Choices.js -->
<script src="{{ url_for('static', filename='admin/js/plugins/choices.min.js') }}"></script>
<!-- DataTables -->
<script src="{{ url_for('static', filename='admin/js/plugins/datatables.js') }}"></script>
<script>
// Available roles (populated from server)
const availableRoles = {{ roles|tojson if roles else '[]' }};

// Store Choices instances
let assignRoleChoices = null;
let removeRoleChoices = null;

function openAssignRoleModal(userId) {
  document.getElementById('assign_user_id').value = userId;
  document.getElementById('assignRoleForm').action = `/admin/users/${userId}/roles`;

  const roleSelect = document.getElementById('role_name');

  // Destroy existing Choices instance if it exists
  if (assignRoleChoices) {
    assignRoleChoices.destroy();
    assignRoleChoices = null;
  }

  // Reset select options
  roleSelect.innerHTML = '<option value="">Select a role...</option>';
  availableRoles.forEach(roleName => {
    const option = document.createElement('option');
    option.value = roleName;
    option.textContent = roleName;
    roleSelect.appendChild(option);
  });

  const modal = new bootstrap.Modal(document.getElementById('assignRoleModal'));
  modal.show();

  // Initialize Choices.js after modal is shown
  const assignRoleModalEl = document.getElementById('assignRoleModal');
  assignRoleModalEl.addEventListener('shown.bs.modal', function() {
    if (typeof Choices !== 'undefined') {
      assignRoleChoices = new Choices(roleSelect, {
        placeholder: true,
        placeholderValue: 'Select a role...',
        searchEnabled: false
      });
    }
  }, { once: true });
}

function openRemoveRoleModal(userId, userRoles) {
  document.getElementById('remove_user_id').value = userId;
  document.getElementById('removeRoleForm').action = `/admin/users/${userId}/roles/remove`;

  const roleSelect = document.getElementById('remove_role_name');

  // Destroy existing Choices instance if it exists
  if (removeRoleChoices) {
    removeRoleChoices.destroy();
    removeRoleChoices = null;
  }

  // Reset select options
  roleSelect.innerHTML = '<option value="">Select a role...</option>';

  if (userRoles && userRoles.length > 0) {
    userRoles.forEach(roleName => {
      const option = document.createElement('option');
      option.value = roleName;
      option.textContent = roleName;
      roleSelect.appendChild(option);
    });
  } else {
    // User has no roles
    const option = document.createElement('option');
    option.value = '';
    option.textContent = 'No roles to remove';
    option.disabled = true;
    roleSelect.appendChild(option);
  }

  const modal = new bootstrap.Modal(document.getElementById('removeRoleModal'));
  modal.show();

  // Initialize Choices.js after modal is shown
  const removeRoleModalEl = document.getElementById('removeRoleModal');
  removeRoleModalEl.addEventListener('shown.bs.modal', function() {
    if (typeof Choices !== 'undefined') {
      removeRoleChoices = new Choices(roleSelect, {
        placeholder: true,
        placeholderValue: 'Select a role...',
        searchEnabled: false
      });
    }
  }, { once: true });
}

function openDeleteUserModal(userId, userEmail, userUsername, projectCount) {
  // Set user information in modal
  document.getElementById('delete_user_email').textContent = userEmail;
  document.getElementById('delete_user_username').textContent = userUsername;
  document.getElementById('delete_user_projects_count').textContent = projectCount;
  document.getElementById('delete_projects_count_detail').textContent = projectCount + ' project(s)';

  // Set form actions
  document.getElementById('deleteUserForm').action = `/admin/users/${userId}/delete`;
  document.getElementById('anonymizeUserForm').action = `/admin/users/${userId}/anonymize`;

  // Show/hide details based on action type (both shown by default)
  document.getElementById('hard_delete_detail').style.display = 'list-item';
  document.getElementById('anonymize_detail').style.display = 'list-item';

  // Show modal
  const modal = new bootstrap.Modal(document.getElementById('deleteUserModal'));
  modal.show();
}

// Initialize DataTable
document.addEventListener('DOMContentLoaded', function() {
  // Initialize DataTable if table exists
  if (document.getElementById('users-table')) {
    const usersTable = new simpleDatatables.DataTable("#users-table", {
      searchable: true,
      fixedHeight: false,
      perPage: 50,
      perPageSelect: [50, 100, 250, -1]
    });
  }

  // Add event listeners for remove role buttons using event delegation
  // This ensures buttons work even after DataTables recreates the DOM
  document.addEventListener('click', function(e) {
    if (e.target.closest('.remove-role-btn')) {
      const button = e.target.closest('.remove-role-btn');
      const userId = button.getAttribute('data-user-id');
      const userRolesString = button.getAttribute('data-user-roles');

      // Convert comma-separated string to array
      let userRoles = [];
      if (userRolesString && userRolesString.trim() !== '') {
        userRoles = userRolesString.split(',').map(role => role.trim()).filter(role => role !== '');
      }

      openRemoveRoleModal(userId, userRoles);
    }

    // Handle delete user button clicks
    if (e.target.closest('.delete-user-btn')) {
      const button = e.target.closest('.delete-user-btn');
      const userId = button.getAttribute('data-user-id');
      const userEmail = button.getAttribute('data-user-email');
      const userUsername = button.getAttribute('data-user-username');
      const projectCount = parseInt(button.getAttribute('data-project-count') || '0', 10);

      openDeleteUserModal(userId, userEmail, userUsername, projectCount);
    }
  });

  // Clean up Choices instances when modals are hidden
  const assignRoleModal = document.getElementById('assignRoleModal');
  const removeRoleModal = document.getElementById('removeRoleModal');

  if (assignRoleModal) {
    assignRoleModal.addEventListener('hidden.bs.modal', function() {
      if (assignRoleChoices) {
        assignRoleChoices.destroy();
        assignRoleChoices = null;
      }
    });
  }

  if (removeRoleModal) {
    removeRoleModal.addEventListener('hidden.bs.modal', function() {
      if (removeRoleChoices) {
        removeRoleChoices.destroy();
        removeRoleChoices = null;
      }
    });
  }
});
</script>
{% endblock %}

