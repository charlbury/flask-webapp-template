{% extends "admin/base.html" %}

{% block title %}Settings{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item text-sm text-dark active font-weight-bold" aria-current="page">Settings</li>
{% endblock %}

{% block content %}
<div class="container-fluid mt-2">
      <div class="row align-items-start flex-column">
        <div class="col-lg-5 ms-3 col-sm-8">
          <h3 class="mb-0 h4 font-weight-bolder">Settings</h3>
          <p class="mb-4">
            Manage your account settings and preferences.
          </p>
        </div>
      </div>
    </div>
    <div class="container-fluid my-3 py-3">
      <div class="row mb-5">
        <div class="col-lg-3">
          <div class="card position-sticky top-1">
            <ul class="nav flex-column bg-white border-radius-lg p-3">
              <li class="nav-item">
                <a class="nav-link text-dark d-flex" data-scroll="" href="#profile">
                  <i class="material-symbols-rounded text-lg me-2">person</i>
                  <span class="text-sm">Profile</span>
                </a>
              </li>
              <li class="nav-item pt-2">
                <a class="nav-link text-dark d-flex" data-scroll="" href="#basic-info">
                  <i class="material-symbols-rounded text-lg me-2">receipt_long</i>
                  <span class="text-sm">Basic Info</span>
                </a>
              </li>
              <li class="nav-item pt-2">
                <a class="nav-link text-dark d-flex" data-scroll="" href="#password">
                  <i class="material-symbols-rounded text-lg me-2">lock</i>
                  <span class="text-sm">Change Password</span>
                </a>
              </li>
              <li class="nav-item pt-2">
                <a class="nav-link text-dark d-flex" data-scroll="" href="#sessions">
                  <i class="material-symbols-rounded text-lg me-2">settings_applications</i>
                  <span class="text-sm">Sessions</span>
                </a>
              </li>
            </ul>
          </div>
        </div>
        <div class="col-lg-9 mt-lg-0 mt-4">
          <!-- Card Profile -->
          <div class="card card-body" id="profile">
            <div class="row align-items-center">
              <div class="col-sm-auto col-4">
                <div class="avatar avatar-xl position-relative">
                  <img id="avatarPreview" src="{{ current_user.get_avatar_url() }}" alt="avatar" class="w-100 rounded-circle shadow-sm">
                </div>
              </div>
              <div class="col-sm-auto col-8 my-auto">
                <div class="h-100">
                  <h5 class="mb-1 font-weight-bolder">
                    {% if current_user.first_name or current_user.last_name %}{{ current_user.first_name }} {{ current_user.last_name }}{% else %}{{ current_user.email }}{% endif %}
                  </h5>
                  <p class="mb-0 font-weight-normal text-sm">
                    {{ current_user.email }}
                  </p>
                </div>
              </div>
            </div>
            <div class="row mt-4">
              <div class="col-12">
                <form method="POST" action="{{ url_for('admin.upload_avatar') }}" enctype="multipart/form-data" id="avatarUploadForm">
                  {{ avatar_form.hidden_tag() }}
                  <div class="mb-4">
                    <label class="form-label mb-2">Upload Avatar</label>
                    <div class="d-flex align-items-center gap-2">
                      {{ avatar_form.avatar(id="avatarFileInput", class="d-none", onchange="openFile(event)") }}
                      <button type="button" class="btn bg-gradient-dark btn-sm" onclick="document.getElementById('avatarFileInput').click()">
                        Choose File
                      </button>
                      <span class="text-muted text-sm" id="avatarFileName">No file chosen</span>
                    </div>
                    {% if avatar_form.avatar.errors %}
                      <div class="invalid-feedback d-block mt-2">
                        {% for error in avatar_form.avatar.errors %}
                          <div>{{ error }}</div>
                        {% endfor %}
                      </div>
                    {% endif %}
                  </div>
                  <p class="text-muted text-sm mt-2 mb-0">
                    Maximum file size: 5MB. Allowed formats: JPG, JPEG, PNG, GIF, WEBP. Images will be automatically resized and cropped to square.
                  </p>
                  {{ avatar_form.submit(class="btn bg-gradient-dark btn-sm mt-3 mb-0") }}
                </form>
              </div>
            </div>
          </div>
          <!-- Card Basic Info -->
          <div class="card mt-4" id="basic-info">
            <div class="card-header">
              <h5>Basic Info</h5>
            </div>
            <div class="card-body pt-0">
              <div class="row">
                <div class="col-6">
                  <div class="input-group input-group-static">
                    <label>First Name</label>
                    <input type="text" class="form-control" placeholder="Alec" value="{% if current_user.first_name %}{{ current_user.first_name }}{% endif %}">
                  </div>
                </div>
                <div class="col-6">
                  <div class="input-group input-group-static">
                    <label>Last Name</label>
                    <input type="text" class="form-control" placeholder="Thompson" value="{% if current_user.last_name %}{{ current_user.last_name }}{% endif %}">
                  </div>
                </div>
              </div>
              <div class="row mt-4">
                <div class="col-6">
                  <div class="input-group input-group-static">
                    <label>Email</label>
                    <input type="email" class="form-control" placeholder="example@email.com" value="{{ current_user.email }}">
                  </div>
                </div>
                <div class="col-6">
                  <div class="input-group input-group-static">
                    <label>Username</label>
                    <input type="text" class="form-control" placeholder="username" value="{{ current_user.username }}">
                  </div>
                </div>
              </div>
              <div class="row mt-4">
                <div class="col-6">
                  <div class="input-group input-group-static">
                    <label>Phone Number</label>
                    <input type="number" class="form-control" placeholder="+40 735 631 620">
                  </div>
                </div>
              </div>
            </div>
          </div>
          <!-- Card Change Password -->
          <div class="card mt-4" id="password">
            <div class="card-header">
              <h5>Change Password</h5>
            </div>
            <div class="card-body pt-0">
              <form method="POST" action="{{ url_for('admin.live_settings') }}">
                {{ form.hidden_tag() }}

                <div class="input-group input-group-outline {% if form.current_password.errors %}is-invalid{% endif %}">
                  <label class="form-label">Current password</label>
                  {{ form.current_password(class="form-control " + ("is-invalid" if form.current_password.errors else "")) }}
                  {% if form.current_password.errors %}
                    <div class="invalid-feedback">
                      {% for error in form.current_password.errors %}
                        <div>{{ error }}</div>
                      {% endfor %}
                    </div>
                  {% endif %}
                </div>

                <div class="input-group input-group-outline my-4 {% if form.new_password.errors %}is-invalid{% endif %}">
                  <label class="form-label">New password</label>
                  {{ form.new_password(class="form-control " + ("is-invalid" if form.new_password.errors else "")) }}
                  {% if form.new_password.errors %}
                    <div class="invalid-feedback">
                      {% for error in form.new_password.errors %}
                        <div>{{ error }}</div>
                      {% endfor %}
                    </div>
                  {% endif %}
                </div>

                <div class="input-group input-group-outline {% if form.confirm_password.errors %}is-invalid{% endif %}">
                  <label class="form-label">Confirm New password</label>
                  {{ form.confirm_password(class="form-control " + ("is-invalid" if form.confirm_password.errors else "")) }}
                  {% if form.confirm_password.errors %}
                    <div class="invalid-feedback">
                      {% for error in form.confirm_password.errors %}
                        <div>{{ error }}</div>
                      {% endfor %}
                    </div>
                  {% endif %}
                </div>

                <h5 class="mt-5">Password requirements</h5>
                <p class="text-muted mb-2">
                  Please follow this guide for a strong password:
                </p>
                <ul class="text-muted ps-4 mb-0 float-start">
                  <li>
                    <span class="text-sm">One special characters</span>
                  </li>
                  <li>
                    <span class="text-sm">Min 6 characters</span>
                  </li>
                  <li>
                    <span class="text-sm">One number (2 are recommended)</span>
                  </li>
                  <li>
                    <span class="text-sm">Change it often</span>
                  </li>
                </ul>
                {{ form.submit(class="btn bg-gradient-dark btn-sm float-end mt-6 mb-0") }}
              </form>
            </div>
          </div>
          <!-- Card Sessions -->
          <div class="card mt-4" id="sessions">
            <div class="card-header pb-3">
              <h5>Sessions</h5>
              <p class="text-sm">This is a list of devices that have logged into your account. Remove those that you do not recognize.</p>
            </div>
            <div class="card-body pt-0">
              {% if sessions %}
                {% for session in sessions %}
                  <div class="d-flex align-items-center">
                    <div class="text-center w-5">
                      {% if session.device_type == 'mobile' %}
                        <i class="fas fa-mobile text-lg opacity-6"></i>
                      {% elif session.device_type == 'tablet' %}
                        <i class="fas fa-tablet text-lg opacity-6"></i>
                      {% else %}
                        <i class="fas fa-desktop text-lg opacity-6"></i>
                      {% endif %}
                    </div>
                    <div class="my-auto ms-3">
                      <div class="h-100">
                        <p class="text-sm mb-1">
                          {% if session.city %}{{ session.city }} {% endif %}{{ session.ip_address }}
                        </p>
                        <p class="mb-0 text-xs">
                          {% if session.is_current %}
                            Your current session
                          {% else %}
                            {% if session.browser_name and session.os_name %}
                              {{ session.browser_name }}{% if session.browser_version %} {{ session.browser_version }}{% endif %} on {{ session.os_name }}{% if session.os_version %} {{ session.os_version }}{% endif %}
                            {% elif session.browser_name %}
                              {{ session.browser_name }}{% if session.browser_version %} {{ session.browser_version }}{% endif %}
                            {% elif session.os_name %}
                              {{ session.os_name }}{% if session.os_version %} {{ session.os_version }}{% endif %}
                            {% else %}
                              Unknown device
                            {% endif %}
                          {% endif %}
                        </p>
                      </div>
                    </div>
                    {% if session.is_active %}
                      <span class="badge badge-success badge-sm my-auto ms-auto me-3">Active</span>
                    {% else %}
                      <span class="badge badge-secondary badge-sm my-auto ms-auto me-3">Inactive</span>
                    {% endif %}
                    {% if session.region or session.country %}
                      <p class="text-secondary text-sm my-auto me-3">{{ session.region or session.country }}</p>
                    {% endif %}
                    {% if session.is_current %}
                      <span class="badge badge-info badge-sm my-auto me-3">Current</span>
                    {% endif %}
                    <form method="POST" action="{{ url_for('admin.revoke_user_session', session_id=session.id) }}" class="d-inline" onsubmit="return confirm('Are you sure you want to revoke this session?{% if session.is_current %} This will log you out immediately.{% endif %}');">
                      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                      <button type="submit" class="btn btn-link text-danger text-sm p-0 my-auto" style="text-decoration: none;">
                        <i class="fas fa-times"></i> Remove
                      </button>
                    </form>
                  </div>
                  {% if not loop.last %}
                    <hr class="horizontal dark">
                  {% endif %}
                {% endfor %}
              {% else %}
                <p class="text-muted text-sm">No sessions found.</p>
              {% endif %}
            </div>
          </div>
        </div>
      </div>

{% endblock %}

{% block extra_scripts %}
<!-- Choices.js library for styled select dropdowns -->
<script src="{{ url_for('static', filename='admin/js/plugins/choices.min.js') }}"></script>
<script>
                  document.write(new Date().getFullYear())
                </script>
<script>
    // Wait for Choices.js to load
    (function() {
      function initChoices() {
        if (typeof Choices === 'undefined') {
          setTimeout(initChoices, 50);
          return;
        }
      }

      // Start initialization
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initChoices);
      } else {
        initChoices();
      }
    })();

    var openFile = function(event) {
      var input = event.target;

      if (input.files && input.files[0]) {
        var file = input.files[0];

        // Check file size (5MB = 5242880 bytes)
        if (file.size > 5242880) {
          alert('File size exceeds 5MB. Please choose a smaller image.');
          input.value = '';
          updateFileName('');
          return;
        }

        // Check file type
        if (!file.type.match(/^image\/(jpeg|jpg|png|gif|webp)$/i)) {
          alert('Invalid file type. Please choose an image file (JPG, PNG, GIF, or WEBP).');
          input.value = '';
          updateFileName('');
          return;
        }

        // Process image: crop to square and replace file
        processAndCropImage(file, input);
      }
    };

    function processAndCropImage(file, input) {
      var reader = new FileReader();

      reader.onload = function(e) {
        var img = new Image();

        img.onload = function() {
          var width = img.width;
          var height = img.height;

          // Maximum dimension for avatar (resize if larger)
          var MAX_DIMENSION = 2000;
          var scale = 1;

          // Calculate scale if image is too large
          if (width > MAX_DIMENSION || height > MAX_DIMENSION) {
            scale = MAX_DIMENSION / Math.max(width, height);
          }

          // Calculate dimensions after scaling
          var scaledWidth = Math.round(width * scale);
          var scaledHeight = Math.round(height * scale);

          // Calculate square crop (center crop) from scaled dimensions
          var size = Math.min(scaledWidth, scaledHeight);
          var x = (scaledWidth - size) / 2;
          var y = (scaledHeight - size) / 2;

          // Create canvas for resizing and cropping
          var canvas = document.createElement('canvas');
          canvas.width = size;
          canvas.height = size;
          var ctx = canvas.getContext('2d');

          // Use high-quality image rendering
          ctx.imageSmoothingEnabled = true;
          ctx.imageSmoothingQuality = 'high';

          // Draw scaled and cropped image to canvas
          // First scale the source coordinates
          var sourceX = x / scale;
          var sourceY = y / scale;
          var sourceSize = size / scale;

          ctx.drawImage(img, sourceX, sourceY, sourceSize, sourceSize, 0, 0, size, size);

          // Determine output format (prefer JPEG for better compression)
          var outputType = 'image/jpeg';
          var outputQuality = 0.85; // Good balance between quality and file size

          // Convert canvas to blob with compression
          canvas.toBlob(function(blob) {
            if (!blob) {
              alert('Error processing image. Please try again.');
              input.value = '';
              updateFileName('');
              return;
            }

            // If compressed file is still too large, reduce quality further
            if (blob.size > 5242880) {
              canvas.toBlob(function(compressedBlob) {
                if (!compressedBlob) {
                  alert('Error compressing image. Please try again.');
                  input.value = '';
                  updateFileName('');
                  return;
                }

                finalizeFile(compressedBlob, file, input);
              }, outputType, 0.75); // Lower quality for very large files
            } else {
              finalizeFile(blob, file, input);
            }
          }, outputType, outputQuality);
        };

        img.onerror = function() {
          alert('Error loading image. Please try a different file.');
          input.value = '';
          updateFileName('');
        };

        img.src = e.target.result;
      };

      reader.onerror = function() {
        alert('Error reading file. Please try again.');
        input.value = '';
        updateFileName('');
      };

      reader.readAsDataURL(file);
    }

    function finalizeFile(blob, originalFile, input) {
      // Create new File object with processed image
      var fileName = originalFile.name.replace(/\.[^/.]+$/, '') + '.jpg'; // Change extension to .jpg
      var processedFile = new File([blob], fileName, {
        type: 'image/jpeg',
        lastModified: Date.now()
      });

      // Replace the file in the input using DataTransfer
      var dataTransfer = new DataTransfer();
      dataTransfer.items.add(processedFile);
      input.files = dataTransfer.files;

      // Update file name display
      updateFileName(processedFile.name);

      // Update preview
      var avatarPreview = document.getElementById("avatarPreview");
      if (avatarPreview) {
        avatarPreview.src = URL.createObjectURL(blob);
      }
    }

    function updateFileName(fileName) {
      var fileNameDisplay = document.getElementById("avatarFileName");
      if (fileNameDisplay) {
        fileNameDisplay.textContent = fileName || "No file chosen";
      }
    }
  </script>
<script>
    var win = navigator.platform.indexOf('Win') > -1;
    if (win && document.querySelector('#sidenav-scrollbar')) {
      var options = {
        damping: '0.5'
      }
      Scrollbar.init(document.querySelector('#sidenav-scrollbar'), options);
    }
  </script>
<script async defer src="https://buttons.github.io/buttons.js"></script>
{% endblock %}

